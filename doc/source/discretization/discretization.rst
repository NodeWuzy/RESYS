----------------------------------------
方程离散的总体思路
----------------------------------------

方程的离散和网格的划分密切相关。
而网格的划分依赖于在输入文件中定义的水力学模型。
因此，RESYS程序在读取完成所有的水力学部件后，会在程序内部生成网格划分的信息。
然后根据网格划分的信息产生稀疏矩阵。

在RESYS程序中，有两种最基本的场(field) ：位于控制体中心的 ``volumefield`` 与 位于接管的 ``junctionfield`` 。 
不同类型的数据会对应与这两种场中的其中一种。比如，密度、压力、温度在RESYS程序中使用 ``volumefield`` 存储。
因为对于这些物理量，其控制体的划分往往都位于单一控制体上。
而对于速度和质量流密度，当使用交错网格时，其控制体划分位于接管上；当使用同位网格时其控制体位于单一控制体上。
由于交错网格在系统分析中描述问题的优势（比如间隙横流强度的存储位置一般都在接管上），所以这类物理量使用 ``junctionfield`` 存储。

首先我们会介绍对于 ``volumefield``  的守恒方程的离散。这一部分比较简单。
然后我们会讨论对于 ``junctionfield``  ，其守恒方程应当如何离散，由于这一部分的情况比较复杂，所以需要仔细讨论。


单一控制体上方程的离散
----------------------------------------

通常，一维的扩散对流方程可以使用如下的方程表述：

.. math::

   \frac{\partial \rho A \phi }{\partial t} +  \frac{\partial \rho u A \phi}{\partial x }  
   = - \frac{\partial}{\partial x}(A \lambda \frac{\partial \phi}{\partial x}) + qA

在上面的方程中，:math:`\phi` 是一个具有普遍意义的变量，在不同的方程中，其具有不同的含义:

- 对于质量守恒方程，:math:`\phi = 1`
- 对于动量守恒方程，:math:`\phi = u`
- 对于能量守恒方程，:math:`\phi = h`

对于上面方程的离散，其第一项是非稳态项，第二项是对流项，第三项是扩散项，第四项是源项。

因此，对于典型的扩散对流方程，其离散主要包括4个部分。
这一小结主要讨论上面所诉的四个部分如何在单一控制体上离散。

对于如下形状的单一控制体：

.. image:: /_static/volume.png
   :height: 200px
   :width:  400px
   :align: center

对于紫色的单一控制体，是我们所要考虑的主控制体。该控制体通过接管与其他的三个控制体相连。
这三个控制体通过对流与扩散，和控制体 ``p`` 发生质量和能量的交换。
尽管上图中所式的流动并非一维的情形，但是一维的对流扩散方程在做不太多的修改之后，依然可以适用。

^^^^^^^^^^^^
源项的离散
^^^^^^^^^^^^

首先，我们对该控制体沿着x方向对一维对流扩散方程积分。
对于源项，我们假定其在控制体内均匀分布，因此，该项变为：

.. math::  
    \int qA dx = qV_p

因此对于源项，其离散后的形式就是控制体内的源强乘以控制体的体积。


^^^^^^^^^^^^
扩散项的离散
^^^^^^^^^^^^

上面所述的一维对流扩散方程不能考虑控制体通过上端的 ``II横流接管`` 的扩散作用，但是将其考虑进来也非常简单。
考虑到扩散项实际上是考虑通过接管在扩散作用下物理量的净通量，我们可以写出扩散项离散后的形式：

.. math::  
    -\int \bigtriangledown . ( \lambda \bigtriangledown \phi ) dV 
    = \sum_{i=1}^{3} A_i \frac{ \lambda_i (\phi_i - \phi_p)}{\Delta x_i}

在上式中，:math:`A_i` 表示 第i个接管的面积。 :math:`\lambda_i` 表示第i个接管处的扩散系数。
:math:`\Delta x_i` 表示第i个接管相邻的两个控制体的距离。对于横流接管，其和输入数据 ``DF`` 与 ``DR`` 间有如下的关系：

.. math::  
    \Delta x_i = DF + DR

.. note::
    对于截面上的扩散系数 :math:`\lambda_i` ，应当使用插值获得。因为最初计算得到的扩散系数的位置处于控制体的中心。
    但是对于 ``II横流接管`` 的湍流扩散系数，其计算出的值直接应用于接管的位置。

对于扩散项的 **显式离散** ，上面得到的项直接加在方程的右端。

对于扩散项的 **隐式离散** ,
上面得到的项的系数，需要加入到方程左端的线性代数方程组的矩阵中。
具体来说，扩散项的系数为：

对于相邻的控制体  ``i`` ：

.. math::  
    a_i = -   A_i \frac{ \lambda_i }{\Delta x_i}

对于主控制体 ``p`` :

.. math::

    a_p = - \sum_{i=1}^{3} a_i 


^^^^^^^^^^^^
对流项的离散
^^^^^^^^^^^^

虽然对流项看起来非常简单，但是其离散过程需要解决一系列的问题。
**中心差分** 在对流项的离散中往往导致数值不稳定性， 而 **迎风差分** 由于不满足二阶精度，在一些问题上又会带来强烈的数值扩散。
因此人们又发展了 **高阶迎风差分格式**。
这些高阶迎风差分格式虽然能减少数值扩散的影响，但是却带来一个新的问题：对于所有的高阶迎风差分，在求解具有较大梯度的物理场时，求解得到的场在界面处会出现有界的震荡。
尽管如此，对于对流项的离散，为了保证数值稳定性，应当使用偏向于 **迎风差分** 的方法。

对流项的离散格式繁多，下面列举一些经常遇到的离散格式：

- 完全迎风差分格式
- QUICK格式
- SOU格式
- FROMM格式

.. note::
    对于高阶迎风格式，由于其离散格式中对于当个控制体涉及比迎风差分更多的相邻的控制体的信息。
    例如对于 ``QUICK格式`` , 其需要上游控制体的前一个控制体的信息。
    适用于完全迎风差分的稀疏矩阵结构不再适用于高阶迎风差分。
    为了解决这一问题，可以使用 ``延时修正`` 方法 。

由于本章节并非是对于计算流体力学的详细叙述，而只是对RESYS程序离散过程的简要讨论。
因此下面只使用迎风差分格式对对流项进行离散。在实际程序中，使用延时修正方法应用高阶格式。

对于上面图中的单一控制体，应用一阶迎风差分格式，我们可以得到对流项的离散格式：

.. math::  
    \int \bigtriangledown (\rho \vec{u} \phi)dV 
    = \sum_{i=1}^{3} A_i \rho_i u_i \dot{\phi} 

:math:`\dot{\phi}` 和截面处的流速相关。假如假设流体流速流入控制体为正，那么上面离散项的值为：

.. math::  

    \sum_{i=1}^{3} A_i \rho_i u_i \dot{\phi} 
    = \sum_{i=1}^{3} A_i \rho_i ( - max( u_i , 0)\phi_i + max(-u_i , 0)\phi_p )

对流项的离散方式有隐式和显式两种。
对于显式离散，直接将上面等式的值的 ``相反数`` 加到方程的右端。
对于隐式离散，需要将方程的对流项系数加到方程的左端。

对于相邻的控制体  ``i`` ，其系数为 ：

.. math::
    a_i = - A_i \rho_i  max( u_i , 0)

对于主控制体 ``p`` , 其系数为：

.. math::
    a_p = \sum_{i=1}^{3} A_i \rho_i max(-u_i , 0)

^^^^^^^^^^^^^^
非稳态项的离散
^^^^^^^^^^^^^^

对于问题情况，这一项为0。对于非稳态情况，这一项需要使用到前一时刻的物理场信息。
在高阶的时间离散格式中，这一项会使用到更加靠前的时间层的信息。
通常情况下，关于时间的常微分方程可以使用如下的形式表示：

.. math::
    \frac{d \vec{\phi}}{dt} = f(\vec{\phi}, t)

在上式中，:math:`\vec{\phi}` 代表着所求解的物理场，函数 :math:`f` 也可能是一个与时间相关的函数。
当我们要对上面的等式进行离散时，我们需要对时间进行积分:

.. math::
    \int \frac{d \vec{\phi}}{dt} dt =  \int f(\vec{\phi}, t) dt

当我们使用向前积分时，会得到显式的离散格式:

.. math::
    \int \frac{d \vec{\phi}}{dt} dt  = f(\vec{\phi}_n, t_n) \Delta t


当我们使用向后积分时，会得到隐式格式

.. math::
   \int \frac{d \vec{\phi}}{dt} dt  = f(\vec{\phi}_{n+1}, t_{n+1}) \Delta t


上面两种方法可以结合起来得到C-N格式：

.. math::
   \int \frac{d \vec{\phi}}{dt} dt  
   = \frac{ f(\vec{\phi}_{n+1}, t_{n+1}) + f(\vec{\phi}_n, t_n) }{2} \Delta t

对于积分式的左端，有不同的表示方法：

``BDF``:

.. math:: 
     \int \frac{d \vec{\phi}}{dt} dt =\vec{\phi}_{n+1} - \vec{\phi}_{n} 

``BDF2``:

.. math:: 
     \int \frac{d \vec{\phi}}{dt} dt = \frac{3}{2}\vec{\phi}_{n+1} - 2\vec{\phi}_{n} +   \frac{1}{2}\vec{\phi}_{n-1}

上面并非完全列举了各种非稳态项的离散方法。这只是对RESYS程序中使用的时间离散方法的简要介绍。


接管上的方程的离散
----------------------------------------

在使用交错网格离散N-S方程组时，动量方程的控制体位于标量场的控制体的界面上。
在RESYS程序中，由于使用一维模型，因此动量方程的控制体位于接管的位置上。
在接管上运用有限体积法比在单一控制体上使用有限体积法要难得多。
因此动量方程使用有限差分法离散。

对于RESYS这样的系统程序，质量守恒和能量守恒的重要性高于动量守恒。
对于质量守恒方程和能量守恒方程，应使用前面所叙述的有限体积法离散，以保证良好的数值特性。
而对于动量守恒方程，可以不使用那么严格的离散格式，可以使用 ``有限差分法`` 代替 ``有限体积法`` 。
因此，对于动量守恒方程，可以使用一些近似以便于对其进行离散，这一小节讨论动量守恒方程在接管上的离散。

对于一个单一控制体，其出口和入口可能存在多个接管，构成一个分支部件。
为了简单和便于理解，首先讨论对于出口和入口只有一个接管的情况下的离散。
然后再推广到分支部件出口和入口具有多个接管的情况，以及考虑横流接管时动量方程的离散。

对于一维单相流动动量方程，其形式为：

.. math::

   \frac{\partial \rho u}{\partial t} +  \frac{\partial \rho u^2 }{\partial x}  
   = - \frac{\partial p}{\partial x} - \frac{F_{wall fraction}}{A} + \rho g_x  

在接管上动量方程的离散基于上式的有限差分近似。

对于下图中的接管控制体，上面方程离散后的的格式为：

.. image:: /_static/junction.png
   :height: 160px
   :width:  300px
   :align: center


.. math::

   \frac{\partial \rho u}{\partial t} \delta x_i +  (\rho u^2)_R - (\rho u^2)_L  \\

   = - (p_R - p_L) - \frac{F_{wall fraction}}{A}\delta x_i  + \rho g_x \delta x_i - H_{ form loss } 

.. note::
    动量方程中不考虑扩散项，扩散项在动量方程中被忽略。
    由于动量方程在RESYS这类的反应堆系统程序中的作用主要是计算出回路的压降与流量。
    而且形阻压降和摩擦压降在方程中占据主导作用，因此动量对流项的离散格式可以不使用严格的迎风差分。

.. note::
    如果动量方程的对流项使用隐式求解，会导致对于动量方程的矩阵的构造变得复杂。
    通常来说，并没有用必要在RESYS这样的系统程序中对动量方程的对流项使用隐式方法求解。
    
    由于壁面摩擦项和形阻压降在动量方程里面占据主导作用，因此这些项线性化之后使用隐式离散。


关于形阻压降 :math:`H_{ form loss }` 与摩擦压降  :math:`F_{wall fraction}` 的计算，会在单独的章节独立讨论。
当接管处于分支部件之上时，这两项的计算会变得更加复杂以合理的考虑实际的物理情况。

对于动量方程的对流项，可以选择使用隐式或者显式离散格式。
对流项隐式离散格式的动量方程中会包含与该接管相邻的控制体的其他接管的速度项，这会使得离散后的方程变得更加复杂。

一个更具有普遍意义的例子是考虑分支部件的接管上的动量方程的离散：

.. image:: /_static/branch.png
   :height: 250px
   :width:  350px
   :align: center

对于接管1，其右端控制体中心的流动速度 :math:`u_R = u_k` , 对于接管4其左端控制体中心的速度是 :math:`u_L = u_k` 。
现在，关键的问题是，如何求解控制体中心的速度  :math:`u_k`。
利用质量流密度的插值，我们可以得到计算控制体中心速度的插值关系式。关于如何进行进行速度插值这个问题会在流场的插值一节中详细介绍。
插值的结果可以写为：

.. math::
    u_k = \sum_{i=1}^{4} b_i u_i 

于是，当动量方程中的对流相按照隐式离散，速度 :math:`u_1` 、速度 :math:`u_2` 、速度 :math:`u_4` 都会出现在离散后的方程中，此时该方程需要全场联立求解。

对于上面图中的接管3，其是一个 ``T横流接管``。对于 ``T横流接管`` ，描述其物理现象的动量方程有所不同。
例如对于接管3，位于其接管上端的流动方向垂直于接管的流速，于是对应于控制体K的动量方程的对流相无法准确给出。
所以该项就从动量方程中略去，这导致了下面形式的动量方程：

.. math::

   \frac{\partial \rho u}{\partial t}( D_L + D_R ) - (\rho u^2)_L
   = - (p_R - p_L) - \frac{F_{wall fraction}}{A}(D_L)  + \rho g_x (D_L + D_R) - H_{ form loss } 

对于该类型的横流接管，动量方程中的对流项的一半被略去。

在模拟反应堆内部的子通道模型时，需要使用到 ``II横流接管`` , 下图是一个典型的 ``II横流接管`` 模型的示意图：

.. image:: /_static/crossflowjunction.png
   :height: 200px
   :width:  200px
   :align: center

横流 :math:`u_c` 携带质量、能量、动量从通道2流动到通道1。在这种情况下，横流接管的动量方程在两端控制体上离散得到的对流项均会被忽略。
并且横流接管的摩擦阻力项也被取消掉，其效应由形阻压降项等效。这给出如下形式的横流接管上的动量方程：

.. math::

   \frac{\partial \rho u}{\partial t}( D_L + D_R ) 
   = - (p_R - p_L)  + \rho g_x (D_L + D_R) - H_{ form loss } 

对于子通道模型的动量守恒方程，需要加入额外的对流项，以考虑通道之间的动量交换。这会在叙述子通道模型的一章节单独描述。


.. admonition:: 总结
   :class: tip

   在这一章节中，本文简要的讨论了在resys程序中质量、动量、能量方程离散的有关的问题。   
   重点介绍了在单一控制体上离散方程使用的的有限体积法。
   然后介绍了接管控制体上的动量方程的离散，由于这部分需要注意的问题较多。
   因此这关于部分的细节会放在其他章节详细叙述。
